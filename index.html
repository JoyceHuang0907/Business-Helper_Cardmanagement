<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>名片管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .search-focus { transition: all 0.3s ease; }
        .search-focus:focus { box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.1); }
        .loading-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .business-gradient { background: linear-gradient(135deg, #3C2415 0%, #5D4037 50%, #6D4C41 100%); }
        .card-image { object-fit: cover; border-radius: 8px; }
        .delete-loading { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="business-gradient text-white py-8 px-6 shadow-lg">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-4xl font-bold text-center">名片管理系統</h1>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        <!-- Webhook Parameter Warning -->
        <div id="webhookWarning" class="hidden mb-6">
            <div class="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
                <svg class="w-12 h-12 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                <h3 class="text-lg font-semibold text-red-800 mb-2">缺少必要參數</h3>
                <p class="text-red-600 mb-4">請在網址中加入以下參數：</p>
                <div class="bg-white border border-red-200 rounded-lg p-4 text-left text-sm font-mono">
                    <p class="mb-2"><strong>載入資料 Webhook：</strong> ?loadWebhook=YOUR_LOAD_WEBHOOK_URL</p>
                    <p><strong>刪除資料 Webhook：</strong> &deleteWebhook=YOUR_DELETE_WEBHOOK_URL</p>
                </div>
                <p class="text-red-600 mt-4 text-sm">
                    範例：<br>
                    <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs break-all">
                        ?loadWebhook=https://hook.us1.make.com/xxxxx&deleteWebhook=https://hook.us1.make.com/yyyyy
                    </span>
                </p>
            </div>
        </div>

        <!-- Search Section -->
        <div id="searchSection" class="mb-8">
            <div class="relative max-w-2xl mx-auto">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="搜尋姓名、暱稱、公司、職稱、電話或其他資訊..."
                    class="w-full px-6 py-4 text-lg border-2 border-gray-200 rounded-xl search-focus focus:border-amber-600 focus:outline-none bg-white shadow-sm"
                >
                <div class="absolute right-4 top-1/2 transform -translate-y-1/2">
                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden text-center py-12">
            <div class="loading-spinner w-12 h-12 border-4 border-amber-200 border-t-amber-700 rounded-full mx-auto mb-4"></div>
            <p class="text-gray-600 text-lg">正在載入名片資料...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden text-center py-12">
            <div class="bg-red-50 border border-red-200 rounded-xl p-8 max-w-md mx-auto">
                <svg class="w-12 h-12 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                <h3 class="text-lg font-semibold text-red-800 mb-2">載入失敗</h3>
                <p class="text-red-600 mb-4" id="errorMessage">無法載入名片資料，請稍後再試</p>
                <button onclick="loadData()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors">
                    重新載入
                </button>
            </div>
        </div>

        <!-- Cards Grid -->
        <div id="cardsContainer" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Cards will be inserted here -->
        </div>

        <!-- No Results -->
        <div id="noResults" class="hidden text-center py-12">
            <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">找不到相關名片</h3>
            <p class="text-gray-500">請嘗試其他關鍵字搜尋</p>
        </div>
    </main>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl">
            <div class="text-center">
                <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">確認刪除</h3>
                <p class="text-gray-600 mb-6">確定要刪除 <span id="deleteTargetName" class="font-semibold"></span> 的名片嗎？此操作無法復原。</p>
                <div class="flex gap-3 justify-center">
                    <button onclick="cancelDelete()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                        取消
                    </button>
                    <button id="confirmDeleteBtn" onclick="confirmDelete()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                        確認刪除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allCards = [];
        let deleteTarget = null;
        let LOAD_WEBHOOK_URL = '';
        let DELETE_WEBHOOK_URL = '';

        // 您提供的真實資料（作為備用） - 已加入暱稱欄位
        const realData = [
            {
                "姓名": "李姿瑩",
                "英文名": "Zin",
                "暱稱": "阿瑩",
                "公司行號": "禹動科技整合股份有限公司",
                "職稱": "專案顧問 Project Consultant",
                "E-mail信箱": "zin@smart4a.tw",
                "電話": "",
                "手機": "+886 975 390 798",
                "傳真號碼": "",
                "公司地址": "106433 台北市大安區忠孝東路四段300號5樓",
                "公司網站": "smart4a.tw",
                "公司統編": "94238652",
                "LineID": "",
                "名片圖檔網址": "",
                "lineUserId": "Ub1457c93602bcaddb8be00d3ccded53d",
                "資料修改表單連結": "https://joycehuang0907.github.io/Business-Helper_CardUpload/?webhook=https://hook.us1.make.com/n9h3p4i9a449irikbjfm8gqklxrjkkkh&lineUserId=Ub1457c93602bcaddb8be00d3ccded53d&name=%E6%9D%8E%E5%A7%BF%E7%91%A9&englishName=Zin&company=%E7%A6%B9%E5%8B%95%E7%A7%91%E6%8A%80%E6%95%B4%E5%90%88%E8%82%A1%E4%BB%BD%E6%9C%89%E9%99%90%E5%85%AC%E5%8F%B8&position=%E5%B0%88%E6%A1%88%E9%A1%A7%E5%95%8F%20Project%20Consultant&email=zin@smart4a.tw&phone=&mobile=+886 975 390 798&fax=&address=106433%20%E5%8F%B0%E5%8C%97%E5%B8%82%E5%A4%A7%E5%AE%89%E5%8D%80%E5%BF%A0%E5%AD%9D%E6%9D%B1%E8%B7%AF%E5%9B%9B%E6%AE%B5300%E8%99%9F5%E6%A8%93&website=smart4a.tw&taxNumber=94238652&lineId=&cardImage="
            },
            {
                "姓名": "黃竹瑄",
                "英文名": "Joyce",
                "暱稱": "KK",
                "公司行號": "禹動科技整合股份有限公司",
                "職稱": "專案經理 Project Manager",
                "E-mail信箱": "joyce@smart4a.tw",
                "電話": "",
                "手機": "+886972763153",
                "傳真號碼": "",
                "公司地址": "100024 台北市中正區忠孝東路一段76號3樓之一",
                "公司網站": "smart4a.tw",
                "公司統編": "94238652",
                "LineID": "",
                "名片圖檔網址": "https://lh3.googleusercontent.com/d/1McWJqPSEGbEh5tIwrdrl4ee3yeAod4lr",
                "lineUserId": "Ub82a39b64d3f46f5fe205dd9752f337f",
                "資料修改表單連結": "https://joycehuang0907.github.io/Business-Helper_CardUpload/?webhook=https://hook.us1.make.com/n9h3p4i9a449irikbjfm8gqklxrjkkkh&lineUserId=Ub82a39b64d3f46f5fe205dd9752f337f&name=%E9%BB%83%E7%AB%B9%E7%91%84&englishName=Joyce&company=%E7%A6%B9%E5%8B%95%E7%A7%91%E6%8A%80%E6%95%B4%E5%90%88%E8%82%A1%E4%BB%BD%E6%9C%89%E9%99%90%E5%85%AC%E5%8F%B8&position=%E5%B0%88%E6%A1%88%E7%B6%93%E7%90%86%20Project%20Manager&email=joyce@smart4a.tw&phone=&mobile=+886972763153&fax=&address=100024%20%E5%8F%B0%E5%8C%97%E5%B8%82%E4%B8%AD%E6%AD%A3%E5%8D%80%E5%BF%A0%E5%AD%9D%E6%9D%B1%E8%B7%AF%E4%B8%80%E6%AE%B576%E8%99%9F3%E6%A8%93%E4%B9%8B%E4%B8%80&website=smart4a.tw&taxNumber=94238652&lineId=&cardImage=https://lh3.googleusercontent.com/d/1McWJqPSEGbEh5tIwrdrl4ee3yeAod4lr"
            }
        ];

        // 從 URL 參數獲取 webhook 網址
        function getUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const loadWebhook = urlParams.get('loadWebhook');
            const deleteWebhook = urlParams.get('deleteWebhook');
            
            console.log('URL 參數:', { loadWebhook, deleteWebhook });
            
            return { loadWebhook, deleteWebhook };
        }

        // 檢查並設定 webhook 網址
        function initializeWebhooks() {
            const { loadWebhook, deleteWebhook } = getUrlParameters();
            
            if (!loadWebhook || !deleteWebhook) {
                console.warn('缺少必要的 webhook 參數');
                showWebhookWarning();
                return false;
            }
            
            // 驗證 URL 格式
            try {
                new URL(loadWebhook);
                new URL(deleteWebhook);
            } catch (error) {
                console.error('Webhook URL 格式不正確:', error);
                showWebhookWarning();
                return false;
            }
            
            LOAD_WEBHOOK_URL = loadWebhook;
            DELETE_WEBHOOK_URL = deleteWebhook;
            
            console.log('Webhook URLs 設定完成:', {
                load: LOAD_WEBHOOK_URL,
                delete: DELETE_WEBHOOK_URL
            });
            
            return true;
        }

        // 顯示 webhook 參數警告
        function showWebhookWarning() {
            document.getElementById('webhookWarning').classList.remove('hidden');
            document.getElementById('searchSection').classList.add('hidden');
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('cardsContainer').classList.add('hidden');
            document.getElementById('noResults').classList.add('hidden');
        }

        // 隱藏所有狀態
        function hideAllStates() {
            document.getElementById('webhookWarning').classList.add('hidden');
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('cardsContainer').classList.add('hidden');
            document.getElementById('noResults').classList.add('hidden');
            document.getElementById('searchSection').classList.remove('hidden');
        }

        // 載入資料
        async function loadData() {
            if (!LOAD_WEBHOOK_URL) {
                console.error('載入 Webhook URL 未設定');
                showWebhookWarning();
                return;
            }

            hideAllStates();
            document.getElementById('loadingState').classList.remove('hidden');

            try {
                console.log('從 Webhook 載入資料...', LOAD_WEBHOOK_URL);
                
                const response = await fetch(LOAD_WEBHOOK_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // 先取得原始文字內容來檢查
                const rawText = await response.text();
                
                // 嘗試修復常見的 JSON 問題
                let cleanedText = rawText;
                
                // 移除可能的 BOM 字符
                cleanedText = cleanedText.replace(/^\uFEFF/, '');
                
                // 移除末尾多餘的逗號
                cleanedText = cleanedText.replace(/,(\s*[}\]])/g, '$1');
                
                // 嘗試解析 JSON
                let data;
                try {
                    data = JSON.parse(cleanedText);
                } catch (cleanError) {
                    console.error('清理後仍無法解析 JSON:', cleanError);
                    
                    // 如果還是失敗，嘗試更積極的修復
                    try {
                        // 可能是多個 JSON 物件連在一起，嘗試分割
                        const jsonObjects = cleanedText.trim().split('}\n{');
                        if (jsonObjects.length > 1) {
                            // 修復分割後的 JSON 格式
                            const fixedObjects = jsonObjects.map((obj, index) => {
                                if (index > 0 && !obj.startsWith('{')) obj = '{' + obj;
                                if (index < jsonObjects.length - 1 && !obj.endsWith('}')) obj = obj + '}';
                                return obj;
                            });
                            
                            data = fixedObjects.map(obj => JSON.parse(obj));
                        } else {
                            throw cleanError;
                        }
                    } catch (finalError) {
                        throw new Error(`JSON 解析失敗: ${finalError.message}`);
                    }
                }

                // 確保資料是陣列格式
                if (!Array.isArray(data)) {
                    data = [data];
                }

                if (data.length === 0) {
                    throw new Error('Webhook 回傳空陣列');
                }

                console.log(`成功載入 ${data.length} 筆資料`);
                allCards = data;
                
                hideAllStates();
                displayCards(allCards);

            } catch (error) {
                console.error('Webhook 載入失敗:', error);
                
                // 顯示錯誤並使用備用資料
                document.getElementById('errorMessage').textContent = `載入失敗: ${error.message}，使用備用資料`;
                document.getElementById('errorState').classList.remove('hidden');
                
                // 3秒後自動切換到備用資料
                setTimeout(() => {
                    allCards = realData;
                    hideAllStates();
                    displayCards(allCards);
                    showNotification('已切換至備用資料', 'info');
                }, 3000);
            }
        }

        // 顯示名片
        function displayCards(cards) {
            const container = document.getElementById('cardsContainer');
            const noResults = document.getElementById('noResults');
            
            if (cards.length === 0) {
                container.classList.add('hidden');
                noResults.classList.remove('hidden');
                return;
            }

            noResults.classList.add('hidden');
            container.classList.remove('hidden');
            
            container.innerHTML = cards.map(card => createCardHTML(card)).join('');
        }

        // 顯示刪除確認對話框
        function showDeleteModal(card) {
            if (!DELETE_WEBHOOK_URL) {
                showNotification('刪除功能未配置，請檢查 deleteWebhook 參數', 'error');
                return;
            }
            
            deleteTarget = card;
            document.getElementById('deleteTargetName').textContent = card.姓名 || '未提供姓名';
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        // 取消刪除
        function cancelDelete() {
            deleteTarget = null;
            document.getElementById('deleteModal').classList.add('hidden');
        }

        // 確認刪除
        async function confirmDelete() {
            if (!deleteTarget || !DELETE_WEBHOOK_URL) return;

            const confirmBtn = document.getElementById('confirmDeleteBtn');
            const originalText = confirmBtn.textContent;
            
            // 顯示載入狀態
            confirmBtn.textContent = '刪除中...';
            confirmBtn.disabled = true;
            confirmBtn.classList.add('delete-loading');

            try {
                const deleteData = {
                    function: '刪除資料',
                    name: deleteTarget.姓名 || '',
                    email: deleteTarget['E-mail信箱'] || '',
                    lineUserId: deleteTarget.lineUserId || ''
                };

                console.log('發送刪除請求:', deleteData, 'URL:', DELETE_WEBHOOK_URL);

                const response = await fetch(DELETE_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(deleteData)
                });

                if (response.ok) {
                    console.log('刪除請求已成功發送');
                    
                    // 從本地陣列中移除該名片
                    allCards = allCards.filter(card => 
                        card.姓名 !== deleteTarget.姓名 || 
                        card['E-mail信箱'] !== deleteTarget['E-mail信箱']
                    );
                    
                    // 重新顯示名片
                    displayCards(allCards);
                    
                    // 關閉對話框
                    cancelDelete();
                    
                    // 顯示成功訊息
                    showNotification('名片已成功刪除', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

            } catch (error) {
                console.error('刪除失敗:', error);
                showNotification('刪除失敗，請稍後再試', 'error');
            } finally {
                // 恢復按鈕狀態
                confirmBtn.textContent = originalText;
                confirmBtn.disabled = false;
                confirmBtn.classList.remove('delete-loading');
            }
        }

        // 顯示通知訊息
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // 3秒後自動移除
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // 創建名片 HTML（注意：暱稱不會顯示在卡片上）
        function createCardHTML(card) {
            const {
                姓名 = '',
                英文名 = '',
                暱稱 = '', // 暱稱欄位（不顯示）
                公司行號 = '',
                職稱 = '',
                'E-mail信箱': email = '',
                電話 = '',
                手機 = '',
                傳真號碼 = '',
                公司地址 = '',
                公司網站 = '',
                公司統編 = '',
                LineID = '',
                名片圖檔網址 = '',
                lineUserId = '',
                資料修改表單連結 = ''
            } = card;

            const displayName = 姓名 || '未提供姓名';
            const hasImage = 名片圖檔網址 && 名片圖檔網址.trim() !== '';
            
            // 將卡片物件編碼為字符串，避免 JSON 特殊字符問題
            const cardDataEncoded = encodeURIComponent(JSON.stringify(card));

            return `
                <div class="bg-white rounded-xl shadow-lg card-hover border border-gray-100 overflow-hidden">
                    <!-- Card Image Section -->
                    <div class="h-48 bg-gray-100 flex items-center justify-center border-b border-gray-200">
                        ${hasImage ? 
                            `<img src="${名片圖檔網址}" alt="${displayName}的名片" class="w-full h-full card-image object-contain" onerror="this.parentElement.innerHTML='<div class=\\'text-gray-500 text-center p-4\\'><svg class=\\'w-12 h-12 mx-auto mb-2 text-gray-300\\' fill=\\'none\\' stroke=\\'currentColor\\' viewBox=\\'0 0 24 24\\'><path stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\' stroke-width=\\'2\\' d=\\'M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z\\'></path></svg><p class=\\'text-sm\\'>圖片載入失敗</p></div>'">` :
                            `<div class="text-gray-500 text-center p-4">
                                <svg class="w-12 h-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                <p class="text-sm">尚未提供名片</p>
                            </div>`
                        }
                    </div>
                    
                    <!-- Card Content -->
                    <div class="p-6">
                        <!-- Name and Title -->
                        <div class="mb-4">
                            <h3 class="text-xl font-bold text-gray-900 mb-1">${displayName}</h3>
                            ${英文名 ? `<p class="text-gray-600 text-sm mb-1">${英文名}</p>` : ''}
                            ${職稱 ? `<p class="text-amber-700 font-medium text-sm">${職稱}</p>` : ''}
                        </div>

                        <!-- Company Info -->
                        ${公司行號 ? `
                            <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                                <p class="font-semibold text-gray-800 text-sm">${公司行號}</p>
                                ${公司統編 ? `<p class="text-gray-600 text-xs mt-1">統編: ${公司統編}</p>` : ''}
                            </div>
                        ` : ''}

                        <!-- Contact Info -->
                        <div class="space-y-2 mb-4">
                            ${email ? `
                                <div class="flex items-center text-sm">
                                    <svg class="w-4 h-4 text-gray-400 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                    </svg>
                                    <a href="mailto:${email}" class="text-amber-700 hover:text-amber-900 break-all">${email}</a>
                                </div>
                            ` : ''}
                            
                            ${手機 ? `
                                <div class="flex items-center text-sm">
                                    <svg class="w-4 h-4 text-gray-400 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <a href="tel:${手機}" class="text-gray-700 hover:text-amber-700">${手機}</a>
                                </div>
                            ` : ''}
                            
                            ${電話 ? `
                                <div class="flex items-center text-sm">
                                    <svg class="w-4 h-4 text-gray-400 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                    </svg>
                                    <a href="tel:${電話}" class="text-gray-700 hover:text-amber-700">${電話}</a>
                                </div>
                            ` : ''}

                            ${LineID ? `
                                <div class="flex items-center text-sm">
                                    <svg class="w-4 h-4 text-gray-400 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.627-.63h2.386c.349 0 .63.285.63.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.627-.63.349 0 .631.285.631.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"></path>
                                    </svg>
                                    <span class="text-gray-700">${LineID}</span>
                                </div>
                            ` : ''}

                            ${公司地址 ? `
                                <div class="flex items-start text-sm">
                                    <svg class="w-4 h-4 text-gray-400 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    <span class="text-gray-700">${公司地址}</span>
                                </div>
                            ` : ''}

                            ${公司網站 ? `
                                <div class="flex items-center text-sm">
                                    <svg class="w-4 h-4 text-gray-400 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m-9 9a9 9 0 019-9"></path>
                                    </svg>
                                    <a href="${公司網站.startsWith('http') ? 公司網站 : 'https://' + 公司網站}" target="_blank" class="text-amber-700 hover:text-amber-900 break-all">${公司網站}</a>
                                </div>
                            ` : ''}
                        </div>

                        <!-- Action Buttons -->
                        <div class="pt-4 border-t border-gray-200">
                            <div class="flex gap-2">
                                ${資料修改表單連結 ? `
                                    <a href="${資料修改表單連結}" target="_blank" class="flex-1 bg-gradient-to-r from-amber-900 to-yellow-900 text-white py-2 px-4 rounded-lg hover:from-amber-950 hover:to-yellow-950 transition-all duration-200 text-sm font-medium text-center">
                                        編輯資料
                                    </a>
                                ` : ''}
                                <button onclick="handleDeleteClick('${cardDataEncoded}')" class="flex-shrink-0 bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors text-sm font-medium flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                    刪除
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 處理刪除按鈕點擊事件
        function handleDeleteClick(encodedCardData) {
            try {
                const card = JSON.parse(decodeURIComponent(encodedCardData));
                showDeleteModal(card);
            } catch (error) {
                console.error('解析卡片資料失敗:', error);
                showNotification('操作失敗，請重新整理頁面', 'error');
            }
        }

        // 搜尋功能（已修改為包含暱稱欄位）
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                displayCards(allCards);
                return;
            }

            const filteredCards = allCards.filter(card => {
                const searchableFields = [
                    card.姓名 || '',
                    card.英文名 || '',
                    card.暱稱 || '', // 加入暱稱欄位到搜尋範圍
                    card.公司行號 || '',
                    card.職稱 || '',
                    card['E-mail信箱'] || '',
                    card.電話 || '',
                    card.手機 || '',
                    card.傳真號碼 || '',
                    card.公司地址 || '',
                    card.公司網站 || '',
                    card.公司統編 || '',
                    card.LineID || ''
                ];
                
                return searchableFields.some(field => 
                    field.toLowerCase().includes(searchTerm)
                );
            });

            displayCards(filteredCards);
        });

        // 關閉對話框的快捷鍵支援
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('deleteModal');
                if (!modal.classList.contains('hidden')) {
                    cancelDelete();
                }
            }
        });

        // 點擊對話框背景關閉
        document.getElementById('deleteModal').addEventListener('click', function(e) {
            if (e.target === this) {
                cancelDelete();
            }
        });

        // Load data on page load
        window.addEventListener('load', function() {
            console.log('頁面載入完成，開始初始化...');
            
            // 首先檢查並設定 webhook
            if (initializeWebhooks()) {
                // 如果 webhook 設定成功，延遲一秒後自動載入資料
                setTimeout(() => {
                    loadData();
                }, 1000);
            }
        });

        console.log('名片管理系統已初始化 - 支援暱稱搜尋功能');
    </script>
</body>
</html>
